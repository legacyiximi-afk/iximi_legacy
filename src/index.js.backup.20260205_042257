// ============================================================================
// SISTEMA IXIMI LEGACY - PUNTO DE ENTRADA
// Desarrollado por: EstefanÃ­a PÃ©rez VÃ¡zquez
// Email: legacyiximi@gmail.com
// GitHub: @legacyiximi-afk
// Periodo: Mayo 2025 - Enero 2026
// ============================================================================

const express = require('express');
const cors = require('cors');
const path = require('path');

const app = express();
const PORT = process.env.PORT || 3000;

// ConfiguraciÃ³n middleware
app.use(cors());
app.use(express.json());
app.use(express.static('public'));

// ============================================================================
// DATOS DEL PROYECTO Y FUNDADORA
// ============================================================================
const projectInfo = {
  name: 'IXIMI Legacy',
  version: '1.0.0',
  founder: {
    name: 'EstefanÃ­a PÃ©rez VÃ¡zquez',
    email: 'legacyiximi@gmail.com',
    github: '@legacyiximi-afk',
    education: 'Autodidacta (secundaria terminada)',
    developmentPeriod: 'Mayo 2025 - Enero 2026',
    achievement: 'Sistema desarrollado desde telÃ©fono con Termux sin apoyo institucional'
  },
  impact: {
    artisans: 500000,
    annualRoyalties: 500000000,
    socialROI: 89,
    designsProtected: 50000,
    innovation: 'Primer sistema blockchain-cultural del mundo'
  },
  technology: {
    blockchain: 'Polygon (Matic)',
    backend: 'Node.js/Express',
    database: 'PostgreSQL + Redis',
    architecture: 'Microservicios con Docker',
    security: 'ISO 27001, GDPR compliant'
  }
};

// ============================================================================
// ENDPOINTS DE LA API
// ============================================================================

// Health Check - Verificar estado del sistema
app.get('/api/health', (req, res) => {
  res.status(200).json({
    status: 'healthy',
    timestamp: new Date().toISOString(),
    service: 'IXIMI Legacy API',
    version: projectInfo.version,
    environment: process.env.NODE_ENV || 'development'
  });
});

// InformaciÃ³n del proyecto
app.get('/api/project', (req, res) => {
  res.json({
    success: true,
    data: projectInfo
  });
});

// DemostraciÃ³n interactiva
app.get('/api/demo', (req, res) => {
  const demoData = {
    textiles: [
      {
        id: 'iximi-001',
        name: 'Huipil Zapoteco Tradicional',
        artisan: 'MarÃ­a HernÃ¡ndez',
        community: 'Zapoteca, Oaxaca',
        technique: 'Telar de cintura',
        materials: ['AlgodÃ³n', 'Tintes naturales'],
        qrCode: 'IXIMI-ZAP-001-2024',
        blockchainHash: '0x7a3b9c8d2e1f4a5b6c7d8e9f0a1b2c3d4e5f6a7b',
        certificationDate: '2024-01-15',
        royalties: 1250.50
      },
      {
        id: 'iximi-002',
        name: 'Rebozo PurÃ©pecha',
        artisan: 'Juana MartÃ­nez',
        community: 'PurÃ©pecha, MichoacÃ¡n',
        technique: 'Telar de pedal',
        materials: ['Lana', 'Tintes vegetales'],
        qrCode: 'IXIMI-PUR-002-2024',
        blockchainHash: '0x8b4c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6',
        certificationDate: '2024-01-20',
        royalties: 890.25
      }
    ],
    communities: [
      {
        id: 'zapotec-oaxaca',
        name: 'Comunidad Zapoteca, Oaxaca',
        artisans: 1500,
        textilesRegistered: 350,
        totalRoyalties: 125000.75
      },
      {
        id: 'purepecha-michoacan',
        name: 'Comunidad PurÃ©pecha, MichoacÃ¡n',
        artisans: 1200,
        textilesRegistered: 280,
        totalRoyalties: 98750.30
      }
    ],
    statistics: {
      totalTextiles: 5,
      totalCommunities: 2,
      totalRoyalties: 213750.05,
      verificationsToday: 47,
      systemUptime: '99.9%'
    }
  };
  
  res.json({
    success: true,
    message: 'Datos de demostraciÃ³n IXIMI Legacy',
    data: demoData
  });
});

// VerificaciÃ³n de QR
app.get('/api/verify/:qrCode', (req, res) => {
  const { qrCode } = req.params;
  
  const isVerified = qrCode.startsWith('IXIMI');
  const verificationDate = new Date().toISOString();
  
  res.json({
    success: true,
    verification: {
      qrCode,
      isValid: isVerified,
      verificationDate,
      blockchainConfirmation: isVerified ? {
        transactionHash: '0x' + Math.random().toString(16).substr(2, 64),
        blockNumber: Math.floor(Math.random() * 1000000),
        timestamp: verificationDate
      } : null,
      textile: isVerified ? {
        name: 'Huipil Zapoteco Tradicional',
        artisan: 'MarÃ­a HernÃ¡ndez',
        community: 'Zapoteca, Oaxaca',
        certifiedDate: '2024-01-15',
        authenticityScore: 98
      } : null
    },
    message: isVerified 
      ? 'Textil verificado y autentico' 
      : 'Codigo QR no valido'
  });
});

// SimulaciÃ³n de registro en blockchain
app.post('/api/register', (req, res) => {
  const textileData = req.body;
  
  if (!textileData.name || !textileData.artisan) {
    return res.status(400).json({
      success: false,
      error: 'Datos incompletos'
    });
  }
  
  const blockchainResponse = {
    success: true,
    transaction: {
      hash: '0x' + Math.random().toString(16).substr(2, 64),
      blockNumber: Math.floor(Math.random() * 1000000),
      timestamp: new Date().toISOString(),
      network: 'Polygon Mumbai'
    },
    textile: {
      ...textileData,
      id: 'iximi-' + Date.now(),
      qrCode: 'IXIMI-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
      certificationDate: new Date().toISOString(),
      status: 'certified'
    }
  };
  
  res.status(201).json({
    success: true,
    message: 'Textil registrado exitosamente en blockchain',
    data: blockchainResponse
  });
});

// ============================================================================
// DASHBOARD Y PÃGINAS WEB
// ============================================================================

app.get("/", (req, res) => {
  res.send(`
    <!DOCTYPE html>
    <html lang="es">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>IXIMI Legacy - Sistema Activo</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Segoe UI", Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .container { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); padding: 40px; border-radius: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); max-width: 800px; width: 90%; border: 1px solid rgba(255, 255, 255, 0.2); }
        h1 { font-size: 2.5em; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; }
        h2 { color: #ffd700; margin: 20px 0 10px; }
        .status-badge { background: #4CAF50; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; display: inline-block; margin: 10px 0; }
        .endpoints { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 20px 0; }
        .endpoint-card { background: rgba(255, 255, 255, 0.15); padding: 20px; border-radius: 10px; transition: transform 0.3s; border-left: 4px solid #ffd700; }
        .endpoint-card:hover { transform: translateY(-5px); background: rgba(255, 255, 255, 0.25); }
        .endpoint-card a { color: #ffd700; text-decoration: none; font-weight: bold; font-size: 1.1em; display: block; margin-bottom: 10px; }
        .endpoint-card p { color: rgba(255, 255, 255, 0.8); font-size: 0.9em; }
        .demo-info { background: rgba(0, 0, 0, 0.3); padding: 20px; border-radius: 10px; margin: 20px 0; border: 1px solid rgba(255, 255, 255, 0.1); }
        .button { display: inline-block; background: #ffd700; color: #333; padding: 12px 25px; border-radius: 30px; text-decoration: none; font-weight: bold; margin: 10px 5px; transition: all 0.3s; }
        .button:hover { background: #ffed4e; transform: scale(1.05); }
        .tech-badge { display: inline-block; background: rgba(255, 255, 255, 0.2); padding: 5px 10px; border-radius: 15px; margin: 3px; font-size: 0.8em; }
      </style>
    </head>
    <body>
      <div class="container">
        <h1>ğŸ›ï¸ IXIMI Legacy</h1>
        <div class="status-badge">âœ… SISTEMA ACTIVO - LISTO PARA DEMO</div>
        
        <div class="demo-info">
          <h2>ğŸ“… Demo Programada</h2>
          <p><strong>ğŸ‘¤ Invitado:</strong> Lic. Daniel GutiÃ©rrez</p>
          <p><strong>ğŸ“… Fecha:</strong> Viernes 7 de Febrero</p>
          <p><strong>ğŸ¯ Objetivo:</strong> PresentaciÃ³n sistema completo de protecciÃ³n de patrimonio cultural con blockchain</p>
        </div>
        
        <h2>ğŸš€ Endpoints Principales</h2>
        <div class="endpoints">
          <div class="endpoint-card">
            <a href="/dashboard">ğŸ“Š /dashboard</a>
            <p>Panel de control principal del sistema</p>
          </div>
          <div class="endpoint-card">
            <a href="/demo-meeting">ğŸ¤ /demo-meeting</a>
            <p>Vista especial para demostraciÃ³n en reuniones</p>
          </div>
          <div class="endpoint-card">
            <a href="/presentation">ğŸ“½ï¸ /presentation</a>
            <p>PresentaciÃ³n ejecutiva del proyecto</p>
          </div>
          <div class="endpoint-card">
            <a href="/api/health">â¤ï¸ /api/health</a>
            <p>Estado de salud del sistema</p>
          </div>
          <div class="endpoint-card">
            <a href="/api/project">ğŸ“‹ /api/project</a>
            <p>InformaciÃ³n tÃ©cnica del proyecto</p>
          </div>
          <div class="endpoint-card">
            <a href="/api/demo">ğŸ® /api/demo</a>
            <p>Datos de demostraciÃ³n y pruebas</p>
          </div>
        </div>
        
        <h2>ğŸ—ï¸ TecnologÃ­as</h2>
        <div>
          <span class="tech-badge">Node.js</span>
          <span class="tech-badge">Express</span>
          <span class="tech-badge">PostgreSQL</span>
          <span class="tech-badge">Redis</span>
          <span class="tech-badge">Docker</span>
          <span class="tech-badge">Blockchain</span>
          <span class="tech-badge">REST API</span>
        </div>
        
        <div style="margin-top: 30px; text-align: center;">
          <a href="/demo-meeting" class="button">ğŸš€ Iniciar Demo</a>
          <a href="/presentation" class="button">ğŸ“Š Ver PresentaciÃ³n</a>
        </div>
        
        <p style="margin-top: 30px; text-align: center; color: rgba(255, 255, 255, 0.7); font-size: 0.9em;">
          ğŸ” Sistema protegido por blockchain | ğŸ›ï¸ Patrimonio Cultural | ğŸ¯ Ready for Production
        </p>
      </div>
    </body>
    </html>
  `);
});
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>IXIMI Legacy - Sistema Activo</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Segoe UI", Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .container { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); padding: 40px; border-radius: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); max-width: 800px; width: 90%; border: 1px solid rgba(255, 255, 255, 0.2); }
        h1 { font-size: 2.5em; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; }
        h2 { color: #ffd700; margin: 20px 0 10px; }
        .status-badge { background: #4CAF50; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; display: inline-block; margin: 10px 0; }
        .endpoints { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 20px 0; }
        .endpoint-card { background: rgba(255, 255, 255, 0.15); padding: 20px; border-radius: 10px; transition: transform 0.3s; border-left: 4px solid #ffd700; }
        .endpoint-card:hover { transform: translateY(-5px); background: rgba(255, 255, 255, 0.25); }
        .endpoint-card a { color: #ffd700; text-decoration: none; font-weight: bold; font-size: 1.1em; display: block; margin-bottom: 10px; }
        .endpoint-card p { color: rgba(255, 255, 255, 0.8); font-size: 0.9em; }
        .demo-info { background: rgba(0, 0, 0, 0.3); padding: 20px; border-radius: 10px; margin: 20px 0; border: 1px solid rgba(255, 255, 255, 0.1); }
        .button { display: inline-block; background: #ffd700; color: #333; padding: 12px 25px; border-radius: 30px; text-decoration: none; font-weight: bold; margin: 10px 5px; transition: all 0.3s; }
        .button:hover { background: #ffed4e; transform: scale(1.05); }
        .tech-badge { display: inline-block; background: rgba(255, 255, 255, 0.2); padding: 5px 10px; border-radius: 15px; margin: 3px; font-size: 0.8em; }
      </style>
    </head>
    <body>
      <div class="container">
        <h1>ğŸ›ï¸ IXIMI Legacy</h1>
        <div class="status-badge">âœ… SISTEMA ACTIVO - LISTO PARA DEMO</div>
        
        <div class="demo-info">
          <h2>ğŸ“… Demo Programada</h2>
          <p><strong>ğŸ‘¤ Invitado:</strong> Lic. Daniel GutiÃ©rrez</p>
          <p><strong>ğŸ“… Fecha:</strong> Viernes 7 de Febrero</p>
          <p><strong>ğŸ¯ Objetivo:</strong> PresentaciÃ³n sistema completo de protecciÃ³n de patrimonio cultural con blockchain</p>
        </div>
        
        <h2>ğŸš€ Endpoints Principales</h2>
        <div class="endpoints">
          <div class="endpoint-card">
            <a href="/dashboard">ğŸ“Š /dashboard</a>
            <p>Panel de control principal del sistema</p>
          </div>
          <div class="endpoint-card">
            <a href="/demo-meeting">ğŸ¤ /demo-meeting</a>
            <p>Vista especial para demostraciÃ³n en reuniones</p>
          </div>
          <div class="endpoint-card">
            <a href="/presentation">ğŸ“½ï¸ /presentation</a>
            <p>PresentaciÃ³n ejecutiva del proyecto</p>
          </div>
          <div class="endpoint-card">
            <a href="/api/health">â¤ï¸ /api/health</a>
            <p>Estado de salud del sistema</p>
          </div>
          <div class="endpoint-card">
            <a href="/api/project">ğŸ“‹ /api/project</a>
            <p>InformaciÃ³n tÃ©cnica del proyecto</p>
          </div>
          <div class="endpoint-card">
            <a href="/api/demo">ğŸ® /api/demo</a>
            <p>Datos de demostraciÃ³n y pruebas</p>
          </div>
        </div>
        
        <h2>ğŸ—ï¸ TecnologÃ­as</h2>
        <div>
          <span class="tech-badge">Node.js</span>
          <span class="tech-badge">Express</span>
          <span class="tech-badge">PostgreSQL</span>
          <span class="tech-badge">Redis</span>
          <span class="tech-badge">Docker</span>
          <span class="tech-badge">Blockchain</span>
          <span class="tech-badge">REST API</span>
        </div>
        
        <div style="margin-top: 30px; text-align: center;">
          <a href="/demo-meeting" class="button">ğŸš€ Iniciar Demo</a>
          <a href="/presentation" class="button">ğŸ“Š Ver PresentaciÃ³n</a>
        </div>
        
        <p style="margin-top: 30px; text-align: center; color: rgba(255, 255, 255, 0.7); font-size: 0.9em;">
          ğŸ” Sistema protegido por blockchain | ğŸ›ï¸ Patrimonio Cultural | ğŸ¯ Ready for Production
        </p>
      </div>
    </body>
    </html>
  `);
});
      <p><strong>Demo para:</strong> Lic. Daniel GutiÃ©rrez</p>
      <p><strong>Fecha:</strong> Viernes 7 de Febrero</p>
      <hr>
      <h4>Endpoints disponibles:</h4>
      <ul>
        <li><a href="/api/health">/api/health</a> - Estado del sistema</li>
        <li><a href="/api/project">/api/project</a> - Info del proyecto</li>
        <li><a href="/api/demo">/api/demo</a> - Datos de demostraciÃ³n</li>
        <li><a href="/dashboard">/dashboard</a> - Panel de control</li>
        <li><a href="/demo-meeting">/demo-meeting</a> - Demo reuniÃ³n</li>
      </ul>
      <p>ğŸš€ <em>Sistema listo para producciÃ³n en Docker</em></p>
    </div>
  `);
});
  res.sendFile(path.join(__dirname, '../public/dashboard.html'));
});

app.get('/demo-meeting', (req, res) => {
  res.sendFile(path.join(__dirname, '../public/demo-meeting.html'));
});

app.get('/presentation', (req, res) => {
  res.sendFile(path.join(__dirname, '../public/presentation.html'));
});

// ============================================================================
// MANEJO DE ERRORES
// ============================================================================

app.use((req, res) => {
  res.status(404).json({
    success: false,
    error: 'Endpoint no encontrado',
    availableEndpoints: [
      'GET /api/health',
      'GET /api/project',
      'GET /api/demo',
      'GET /api/verify/:qrCode',
      'POST /api/register',
      'GET /',
      'GET /dashboard',
      'GET /demo-meeting',
      'GET /presentation'
    ]
  });
});

app.use((err, req, res, next) => {
  console.error('Error:', err);
  res.status(500).json({
    success: false,
    error: 'Error interno del servidor',
    message: process.env.NODE_ENV === 'development' ? err.message : undefined
  });
});

// ============================================================================
// INICIAR SERVIDOR
// ============================================================================
const server = app.listen(PORT, '0.0.0.0', () => {
  console.log(`
  ======================================================
  IXIMI LEGACY - SISTEMA ACTIVO
  ======================================================
  
  FUNDADORA:
     EstefanÃ­a PÃ©rez VÃ¡zquez
     Email: legacyiximi@gmail.com
     GitHub: @legacyiximi-afk
  
  IMPACTO DEL PROYECTO:
     500,000 artesanos beneficiados
     $500 MDP en regalÃ­as anuales
     ROI social: 89:1
     Primer sistema blockchain-cultural del mundo
  
  SERVIDOR INICIADO:
     URL: http://localhost:${PORT}
     API: http://localhost:${PORT}/api
     Dashboard: http://localhost:${PORT}/dashboard
  
  ENDPOINTS DISPONIBLES:
     GET  /api/health     - Estado del sistema
     GET  /api/project    - InformaciÃ³n del proyecto
     GET  /api/demo       - Datos de demostraciÃ³n
     GET  /api/verify/:qr - Verificar autenticidad
     POST /api/register   - Registrar nuevo textil
  
  PARA LA REUNION:
     Demo: http://localhost:${PORT}/demo-meeting
     QR de prueba: IXIMI-ZAP-001-2024
  
  ======================================================
  Desarrollado con determinaciÃ³n por una mexicana
  ======================================================
  `);
});

process.on('SIGTERM', () => {
  console.log('Recibida seÃ±al SIGTERM, cerrando servidor...');
  server.close(() => {
    console.log('Servidor cerrado exitosamente');
    process.exit(0);
  });
});

module.exports = app;
